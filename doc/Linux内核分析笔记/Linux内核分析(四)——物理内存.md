# Linux内核分析(四)——物理内存

## 1. 物理地址空间

### 1.1 物理地址空间介绍

- 物理地址是处理器在系统总线上看到的地址。使用精简指令集（RISC）的处理器通常只实现一个物理地址空间，外围设备和物理内存使用统一的物理地址空间，处理器可以像访问内存单元一样访问外围设备。有些设备把分配给外围设备的物理地址区域成为设备内存。

- 处理器通过外围设备控制器的寄存器访问外围设备，寄存器分为控制寄存器、状态寄存器和数据寄存器三大类。外围设备的寄存器通常被连续地编址。处理器对外围设备寄存器的编址方式有两种：

  > 1. I/O映射方式（I/O-mapped）：英特尔的`x86`处理器为外围设备专门实现了一个单独的地址空间，称为“I/O地址空间”或“I/O端口空间”，处理器通过专门的I/O指令来访问这一空间中的地址单元。
  > 2. 内存映射方式（memory-mapped）：使用精简指令集（RISC）的处理器对外围设备寄存器的编址通常使用这一方式。

- 程序只能通过虚拟地址访问外设寄存器。

  

### 1.2 ARM64架构实现

- ARM64架构定义了两种内存类型：

  > 1. 正常内存（Normal Memory）：包括物理内存和只读存储器（ROM）。
  > 2. 设备内存（Device Memory）：指分配给外围设备寄存器的物理地址区域。

- 本节对正常内存和设备内存不做细述。
- 

### 1.3 物理地址宽度

- 目前ARM64处理器支持的最大物理地址宽度是48位，如果实现了ARMv8.2标准的大物理地址（Large Physical Address，LPA）支持，并且页长度是64KB，那么物理地址的最大宽度是52位。

- 可以使用寄存器TCR_EL1（Translation Control Register for Exception Level 1，异常级别1的转换控制寄存器）的IPS（Intermediate Physical Address Size，中间物理地址长度）控制物理地址的宽度。IPS字段的长度是3位，IPS字段的值和物理地址宽度的对应关系如下表所示：

  | IPS字段 | 物理地址宽度 |
  | ------- | ------------ |
  | 000     | 32位         |
  | 001     | 36位         |
  | 010     | 40位         |
  | 011     | 42位         |
  | 100     | 44位         |
  | 101     | 48位         |
  | 110     | 52位         |



## 2. 物理内存组织

### 2.1 体系结构

- 目前多处理器系统有两种体系结构。

  > 1. 非一致内存访问（Non-Uniform Memory Access，NUMA）：只内存被划分成多个内存节点的多处理器系统，访问一个内存节点花费的时间取决于处理器和内存节点的距离。每个处理器有一个本地内存节点，处理器访问本地内存节点的速度比访问其他内存节点的速度快。NUMA是中高端服务器的主流体系结构。
  > 2. 对称多处理器（Symmetry Multi-Processor，SMP）：即一致内存访问（Uniform Memory Access，UMA），所有处理器访问内存花费的时间是相同的。每个处理器的地位是平等的，仅在内核初始化的时候不平等：“0号处理器作为引导处理器负责初始化内核，其他处理器等待内核初始化完成。”

- 在实际应用中科院采用混合体系结构，在NUMA节点内部使用SMP体系结构。

  

### 2.2 内存模型

