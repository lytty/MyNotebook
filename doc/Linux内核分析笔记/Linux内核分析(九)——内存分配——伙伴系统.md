# Linux内核分析(八)——内存分配——伙伴系统

- 内核初始化完毕后，使用页分配器管理物理页，当前使用页分配器是伙伴分配器，伙伴分配器的特点是算法简单且效率高。

## 1. 概述

- 连续的物理页称为页块（page block）。

- 阶（order）是伙伴系统的一个术语，是页的数量单位，2^n个连续页称为n阶页块。

- 满足以下条件的两个n阶页块称为伙伴（buddy）：

  > 1. 两个页块是相邻的，即物理地址是连续的；
  > 2. 页块的第一页的物理页号必须是2^n的整数倍；
  > 3. 如果合并成（n+1）阶页块，第一页的物理页号必须是2^(n+1)的整数倍。

  这是伙伴分配器（buddy allocator）这个名字的来源。以单页为例说明，0号页和1号页是伙伴，2号页和3号页是伙伴，1号页和2号页不是伙伴，因为1号页和2号页合并组成一阶页块，第一页的物理页号不是2的整数倍。

- 物理分配器分配和释放物理页的数量单位是阶。分配n阶页块的过程如下：

  > 1. 查看是否有空闲的n阶页块，如果有，直接分配；如果没有，继续执行下一步；
  > 2. 查看是否有空闲的(n+1)阶页块，如果有，把（n+1）阶页块分裂为两个n阶页块，一个插入空闲n阶页块链表，另一个分配出去；如果没有，继续执行下一步；
  > 3. 查看是否有空闲的(n+2)阶页块，如果有，把（n+2）阶页块分裂为两个（n+1）阶页块，一个插入空闲（n+1）阶页块链表，另一个分裂为两个n阶页块，一个插入空闲n阶页块链表，另一个分配出去；如果没有，继续查看更高阶是否存在空闲页块。

  释放n阶页块时，查看它的伙伴释放空闲，如果伙伴不空闲，那么把n阶页块插入空闲的n阶页块链表；如果伙伴空闲，那么合并为（n+1）阶页块